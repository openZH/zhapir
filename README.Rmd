---
output: github_document
---

<!-- README.md is generated from README.Rmd. Please edit that file -->

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  fig.path = "man/figures/README-",
  out.width = "100%"
)
```

# ğŸ“¦ zhapir

<!-- badges: start -->

[![R-CMD-check](https://github.com/openZH/zhapir/actions/workflows/R-CMD-check.yaml/badge.svg)](https://github.com/openZH/zhapir/actions/workflows/R-CMD-check.yaml)

<!-- badges: end -->

**zhapir** ist ein R-Paket fÃ¼r die automatisierte Erstellung und Aktualisierung von **DatensÃ¤tzen** und **Distributionen** in der kantonalen *Metadatenverwaltung (MDV)*.\

Damit kÃ¶nnen Inhalte fÃ¼r [zh.ch/opendata](https://zh.ch/opendata) und [opendata.swiss](https://opendata.swiss) effizient gepflegt werden.

ğŸ‘‰ FÃ¼r detaillierte Workflows siehe die Vignette:\

`vignette("best_practices", package = "zhapir")`

## ğŸš€ Installation

Das Paket wird Ã¼ber GitHub installiert:

``` r
# install.packages("remotes")
remotes::install_github("statistikZH/zhapir")
```

## ğŸ”‘ API Key einrichten

Ein API Key ist Voraussetzung, um mit der MDV zu arbeiten.\
Diesen erzeugst du in der GUI:

1.  ğŸ” **API Key generieren**

    ![](man/figures/Token_generieren.png)

    Hier kÃ¶nnt ihr einen beliebigen Namen fÃ¼r den Token wÃ¤hlen. Es ist mÃ¶glich einen Token ohne Ablaufdatum zu genieren (einfach Ablaufdatum frei lassen).

2.  In `.Renviron` eintragen:

    ```{r eval=FALSE}
    # Dies Ã¶ffnet deinen .Renviron file
    usethis::edit_r_environ()
    ```

    Den API-Key als ZHAPIR_API_KEY eintragen. Hier ist der Namen wichtig, da der Key automatisch vom Package ausgelesen wird.

    ```{r eval=FALSE}
    ZHAPIR_API_KEY="xxxxxxxxxxxxxxxx"
    ```

    â—**Danach die R-Session neu starten, damit die Ã„nderung wirksam wird.** â—

## âš ï¸ Wichtig: Entwicklungs- vs. Produktions-Umgebung

StandardmÃ¤ssig verwendet `zhapir` die **Entwicklungs-URL** (`use_dev = TRUE`).\
FÃ¼r produktive Ã„nderungen muss explizit `use_dev = FALSE` gesetzt werden:

```{r eval=FALSE}
ds <- zhapir::create_dataset(
  title           = "Prod Datensatz",
  organisation_id = 14,
  description     = "In PROD erstellt",
  use_dev         = FALSE   # ğŸ‘‰ PROD statt DEV
)
```

## âœ¨ Beispiele

### Datensatz erstellen

```{r eval=FALSE}
ds <- zhapir::create_dataset(
  title           = "Beispiel Datensatz",
  organisation_id = 14,
  description     = "Automatisiert erstellt mit zhapir",
  contact_email   = "team@example.org",
  theme_ids       = c("BevÃ¶lkerung"),
  periodicity_id  = "JÃ¤hrlich",
  use_dev         = FALSE
)
```

â„¹ï¸ Neue DatensÃ¤tze sind in der MDV **immer â€Entwurfâ€œ**.\
Eine Publikation ist nur Ã¼ber die grafische OberflÃ¤che mÃ¶glich und erfolgt immer erst nach der PrÃ¼fung durch die Data Guides. Neue Distributionen anlegen oder bestehende Distributionen updaten lÃ¤sst sich aber vollstÃ¤ndig Ã¼ber die API/R erledigen.

â„¹ï¸ Es ist nicht notwendig das Ergebnis der Funktionen (z.B. `zhapir::create_distribution()`) per `<-` zuzuweisen. Wir nutzen dies hier, um mit der ID eines Datensatzes oder einer Distribution weiterzuarbeiten.

### Distribution hinzufÃ¼gen

```{r eval=FALSE}
# TemporÃ¤r CSV erstellen 
tmpfile <- base::tempfile(fileext = ".csv")
utils::write.csv(data.frame(a = 1:3), tmpfile, row.names = FALSE)

# Neue Distribution mit angehÃ¤ngter Datei hochladen
dist <- zhapir::create_distribution(
  title       = "Beispiel Distribution",
  dataset_id  = ds$id, # Das funktioniert, weil wir oben ds erstellt haben - sonst einfach im GUI die ID (=Nummer) heraussuchen.
  file_path   = tmpfile,
  ogd_flag    = TRUE,
  zh_web_flag = TRUE,
  use_dev     = FALSE
)
```

ğŸ‘‰ **Kniff:** Ãœber `update_distribution()` kannst du auch **Parameter auf Dataset-Ebene** anpassen, ohne separat `update_dataset()` aufzurufen â€“ z. B. `end_date` oder `modified_next`:

```{r eval=FALSE}
dist <- zhapir::update_distribution(
  id            = dist$id,
  modified_next = "2026-01-01", # nÃ¤chstes geplantes Update
  end_date      = "2025-12-31", # Ende der Zeitspanne
  use_dev       = FALSE
)
```

### Datensatz aktualisieren

```{r eval=FALSE}
ds <- zhapir::update_dataset(
  id            = ds$id,
  description   = "Neue Beschreibung",
  modified_next = "2026-01-01",
  use_dev       = FALSE
)
```

### Distribution aktualisieren

```{r eval=FALSE}
dist <- zhapir::update_distribution(
  id          = dist$id,
  description = "Neue Beschreibung Distribution",
  use_dev     = FALSE
)
```

## ğŸ” IDs: Labels â†”ï¸ Codes

Viele Argumente akzeptieren **Labels** (z. B. `"BevÃ¶lkerung"`) oder **IDs** (z. B. `41`):

```{r eval=FALSE}
# via Label
ds1 <- zhapir::create_dataset(
  title           = "Per Label",
  organisation_id = 14,
  theme_ids       = "BevÃ¶lkerung",
  use_dev         = FALSE
)

# via ID
ds2 <- zhapir::create_dataset(
  title           = "Per ID",
  organisation_id = 14,
  theme_ids       = 41,
  use_dev         = FALSE
)
```

Bei Tippfehlern gibt `zhapir` klare Fehlermeldungen mit Hinweisen, z. B.:

``` r
x befÃ¶lkerung not valid
â€¢ run get_themes()
```

Folgende Argumente akzeptieren **Labels** und **IDs**:

-   `keyword_ids`
-   `zh_web_datacatalog_ids`
-   `theme_ids`
-   `periodicity_id`
-   `status_id`
-   `file_format_id`

Folgende Argumente akzeptieren ausschliesslich IDs:

-   `organisation_id`
-   `dataset_id`
-   `license_id`

Mit den `get_[Argument]`-Funktionen kÃ¶nnen die verfÃ¼gbaren Labels sowie die dazugehÃ¶rigen IDs aufgerufen werden, z.B. fÃ¼r `themes`:

```{r eval=FALSE}
# Finde alle `themes`
zhapir::get_themes()

# Finde alle `themes`, welche den den String "Verkehr" enthalten (kÃ¶nnen auch mehrere Strings sein)
zhapir::get_themes("Verkehr")

# Finde alle `themes`, welche die ID 41 enthalten (kÃ¶nnen auch mehrere IDs sein)
zhapir::get_themes(41)
```

> **Wichtig**: `get_organisations()` gibt ausschliesslich alle Organisationen zurÃ¼ck und erlaubt keine Strings oder ID als Input.


## ğŸš« EinschrÃ¤nkungen

Das Paket kann **nicht**:

-   den **Status** eines Datensatzes setzen (neue DatensÃ¤tze sind immer â€Entwurfâ€œ)

-   eine **Publikation** anstossen

Diese Schritte erfolgen ausschliesslich Ã¼ber die grafische OberflÃ¤che des Datenkatalogs.

## ğŸ“„ Lizenz

Codelizenz: Â© 2025 Statistisches Amt Kanton ZÃ¼rich (siehe `LICENSE`)
